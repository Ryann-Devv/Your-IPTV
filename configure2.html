<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <html style="background-image: url(<%=MANIFEST.background%>);">
   <title>Installation Page</title>
   <style>
      html {
        background-size: auto 100%;
        background-size: cover;
        background-position: center center;
        background-repeat: repeat-y;
      }
      body {
        /* background-color: #111111; */
        color: #FFFFFF;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
      }
      .container {
         display: flex;
         justify-content: center;
         align-items: center;
         height: 100vh;
      }
      .form {
         background-color: #222222;
         /* background-color: #222222; */
         border-radius: 10px;
         padding: 40px;
         width: 40%;
         /* height: 30%; */
         box-shadow: 0px 0px 10px rgba(255, 255, 255, 0.1);
      }
      h1 {
         font-size: 28px;
         text-align: center;
         margin-bottom: 30px;
      }
      .form-group {
         margin-bottom: 20px;
      }
      .label {
         display: block;
         font-size: 14px;
         margin-bottom: 5px;
      }
      .input {
         padding: 10px;
         width: 100%;
         border: none;
         background-color: #333333;
         color: #FFFFFF;
         border-radius: 5px;
         font-size: 14px;
      }
      .input:focus {
         outline: none;
      }
      .button-container {
         text-align: center;
         margin-top: 20px;
      }
      .button {
         padding: 10px 20px;
         background-color: #00A8E8;
         border: none;
         color: #FFFFFF;
         text-align: center;
         text-decoration: none;
         display: inline-block;
         font-size: 16px;
         border-radius: 5px;
         cursor: pointer;
         transition: background-color 0.3s ease;
      }
      .button:hover {
         background-color: #0091BF;
      }
      .install-link {
         margin-top: 20px;
      }
      .install-link p {
         font-size: 14px;
         margin-bottom: 10px;
      }
      .install-link a {
         color: #00A8E8;
         text-decoration: none;
         font-size: 14px;
         transition: color 0.3s ease;
      }
      .install-link a:hover {
         color: #0091BF;
      }
   </style>
</head>
<body>
   <div class="container">
      <div class="form">
         <h1>Installation Page</h1>
         <div class="form-group">
            <label class="label" for="listingOption">Listing Option:</label>
            <select id="listingOption" class="input" onchange="changingListing()">
               <option value="url">M3U URL</option>
               <option value="api">API</option>
            </select>
         </div>
         <div class="form-group" id="dnsport">
            <label class="label" id="dnsportLabel">DNS Port:</label>
            <input type="text" id="dnsport" class="input">
         </div>
         <div class="form-group" id="username">
            <label class="label" id="usernameLabel">Username:</label>
            <input type="text" id="username" class="input">
         </div>
         <div class="form-group" id="password">
            <label class="label" id="passwordLabel">Password:</label>
            <input type="password" id="password" class="input">
         </div>
         <div class="form-group" id="iptvURL">
            <label class="label" id="iptvURLLabel">M3U URL:</label>
            <input type="text" id="iptvURL" class="input">
         </div>
         <div id="exampleIPTVurl">
            <p>Example M3U URL: <a href="#" onclick="copy('iptvURL')">Copy</a></p>
            <input type="text" id="exampleURL" class="input" readonly value="http://example.com/playlist.m3u">
         </div>
         <div class="button-container">
            <button class="button" onclick="generateInstallLink()">Generate Install Link</button>
         </div>
         <div class="install-link">
            <p>Install Link:</p>
            <a id="installLink" href="#" target="_blank"></a>
            <input type="text" id="installURL" class="input" readonly>
         </div>
      </div>
   </div>

   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <script type="text/javascript">
    $(document).ready(function() {
       $('#listingOption').val("url")

       $('#dnsport').toggle()
       $("#dnsportLabel").toggle()

       $('#username').toggle()
       $("#usernameLabel").toggle()

       $('#password').toggle()
       $("#passwordLabel").toggle()

       if($('#username').val().length > 0 && $('#password').val().length > 0 && $('#dnsport').val().length > 0){
          generateInstallLink()
       }
    });

    function encode(userData) {
       return btoa(JSON.stringify(userData)).replace(/\+/g, '-').replace(/\//g, '_').split('=')[0]
    }

    function copy(id){
       document.getElementById(id).select();
       document.execCommand("copy");
    }

    function changingListing() {

       const option = $('#listingOption').val()

       $("#dnsport").toggle(option ===  "api")
       $("#dnsportLabel").toggle(option ==  "api")

       $('#username').toggle(option === "api");
       $("#usernameLabel").toggle(option ==  "api")

       $('#password').toggle(option === "api");
       $("#passwordLabel").toggle(option ==  "api")


       $('#iptvURL').toggle(option === "url");
       $("#iptvURLLabel").toggle(option ==  "url")

       $('#exampleIPTVurl').toggle( option === "url")
       
    }

    function getAllUrlParams(url) {

       // get query string from url (optional) or window
       var queryString = url ? url.split('?')[1] : window.location.search.slice(1);

       var baseURL = url.split('/')[0] + "//" + url.split('?')[0].split('/')[2] || null

       // we'll store the parameters here
       var obj = {};

       // if query string exists
       if (queryString) {

       // stuff after # is not part of query string, so get rid of it
       queryString = queryString.split('#')[0];

       // split our query string into its component parts
       var arr = queryString.split('&');

       for (var i = 0; i < arr.length; i++) {
          // separate the keys and the values
          var a = arr[i].split('=');

          // set parameter name and value (use 'true' if empty)
          var paramName = a[0];
          var paramValue = typeof (a[1]) === 'undefined' ? true : a[1];

          // (optional) keep case consistent
          // paramName = paramName.toLowerCase();
          // if (typeof paramValue === 'string') paramValue = paramValue.toLowerCase();

          // if the paramName ends with square brackets, e.g. colors[] or colors[2]
          if (paramName.match(/\[(\d+)?\]$/)) {

             // create key if it doesn't exist
             var key = paramName.replace(/\[(\d+)?\]/, '');
             if (!obj[key]) obj[key] = [];

             // if it's an indexed array e.g. colors[2]
             if (paramName.match(/\[\d+\]$/)) {
             // get the index value and add the entry at the appropriate position
             var index = /\[(\d+)\]/.exec(paramName)[1];
             obj[key][index] = paramValue;
             } else {
             // otherwise add the value to the end of the array
             obj[key].push(paramValue);
             }
          } else {
             // we're dealing with a string
             if (!obj[paramName]) {
             // if it doesn't exist, create property
             obj[paramName] = paramValue;
             } else if (obj[paramName] && typeof obj[paramName] === 'string'){
             // if property does exist and it's a string, convert it to an array
             obj[paramName] = [obj[paramName]];
             obj[paramName].push(paramValue);
             } else {
             // otherwise add the property
             obj[paramName].push(paramValue);
             }
          }
       }
       }
       obj["BaseURL"] = baseURL || null
       return obj;
    }

    function generateInstallLink() {

       var isParametersValid = true

       var params = {}, configuration

       if($('#listingOption').val() === "url"){
          // IF M3U URL OPTION IS SELECTED
          
          var url = $('#iptvURL').val().trim() || ""
          if(url.length > 0){
             // console.log("url:",encode(url))
             params = getAllUrlParams(url)

             if(params && params.output){
                delete params.output
             }
             if(params && params.type){
                delete params.type
             } 
             isParametersValid = true
          }
       }else{
          // IF API OPTION IS SELECTED
       
          var BaseURL = $('#dnsport').val().trim() || null
          var username = $('#username').val().trim() || null
          var password= $('#password').val().trim()|| null

          params = {username,password,BaseURL}
          
          isParametersValid = true
       }

       configuration = encode(params)    

       if(params && params.BaseURL && !params.BaseURL.includes("http") && params.BaseURL.length > 0){
          isParametersValid = false
          alert("Please indicate http or http(s) status!")
       }

       if(params && !params.username){
          isParametersValid = false
          alert("Username is missing!")
       }

       if(params && !params.password){
          isParametersValid = false
          alert("Password is missing!")
       }
                  
       if (params && params.username && params.password && params.BaseURL && isParametersValid === true) {
          installLink.href = 'stremio://' + window.location.host + '/'  + configuration + '/manifest.json';
          document.getElementById("installURL").value = window.location.protocol+"//"+window.location.host+"/"+ configuration+ "/manifest.json";
       }
       
    }
   </script>

</body>
</html>



